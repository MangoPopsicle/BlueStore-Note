ceph综合运用直接写、COW与RMW策略：
任何一个写请求，根据磁盘块的大小将切分为三个部分，即首尾非块大小对齐部分与中间块大小对齐部分，前者采用RMW策略（同时为避免数据损坏风险，引入日志），后者采用COW策略。
![[未命名绘图.png]]
块I/O大小的临界值为`bluestore_min_alloc_size`
![[Pasted image 20221025164032.png]]

>**RMW（Read Modify Write）** 指当覆盖写（即改写已有内容）发生时，如果本次修改的内容不足一个磁盘块大小，则首先读取对应的块，然后将待修改的内容与读取的内容进行合并（从这个角度而言M，也可以理解为Merge），最后将更新后的块重新写入原先位置。RMW引入了两个问题：一个是额外的读惩罚；二是覆盖写过程中，如果磁盘异常掉电，那么会存在潜在的数据损坏风险。
>**COW（Copy-On-Write）**，指当覆盖写发生时，不是直接更新磁盘对应位置的已有内容，而是重新在磁盘上分配一块新的空间，用于存放本次新写入的内容，这个过程也称为写时重定向。当新写完成、对应的地址指针更新后，即可释放原有数据对应的磁盘空间。 
>![[2SRY8)8D(]D(%G8KFFKC[W3.jpg]]
 >
>COW理论上可以解决RMW引入的以下两个问题，但是自身也存在缺陷：
>1）COW破坏了数据在磁盘分布的物理连续性。经过多次COW后，前端任意大范围的顺序读，后续都将变为随机读，由于读性能至关重要，所以在机械盘作为主流存储的年代，采用COW机制的存储系统容易遭遇性能瓶颈
>2）COW需要频繁地执行空间重分配和地址指针重定向，最终将引入更多的元数据。由于任何操作必然涉及元数据，所以元数据是存储系统中当之无愧的热点数据。如果元数据过多，导致其无法常驻内存，必然会导致存储性能大打折扣。从这个角度而言，为了提升性能，我们需要减少存储系统的元数据，特别是与空间管理有关的元数据（因为其与管理的空间大小成正比）

